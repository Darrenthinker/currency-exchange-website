# API 限流问题说明和解决方案

## 问题诊断

根据浏览器控制台的错误信息，问题的根本原因是：

**UniRateAPI 免费套餐每日请求限制已用完**
- 错误代码：`429 Too Many Requests`
- 限制：每日 200 次请求
- 当前状态：已用完当日配额
- 重置时间：每天 UTC 0 点（北京时间 8 点）

## 已实施的优化措施

### 1. 禁用预加载功能 ✅
- **问题**：预加载功能会在用户切换货币时自动调用 API，消耗大量配额
- **解决**：完全禁用预加载，只在用户实际需要时才调用 API
- **效果**：减少约 50-70% 的 API 调用

### 2. 改进错误提示 ✅
- **问题**：429 错误时显示通用错误信息，用户不清楚原因
- **解决**：检测到限流错误时，显示明确的提示信息
- **效果**：用户了解问题原因，知道何时可以再次使用

### 3. 24小时缓存机制 ✅
- **问题**：4小时缓存太短，容易导致频繁调用 API
- **解决**：延长到 24 小时，减少 API 调用频率
- **效果**：即使 API 暂时不可用，也能使用缓存数据

## 长期解决方案

### 方案一：升级 API 套餐（推荐）
- **免费套餐**：每日 200 次请求
- **付费套餐**：更多请求次数，更稳定的服务
- **升级地址**：https://unirateapi.com/pricing

### 方案二：优化 API 调用策略
1. **只在固定时间点更新**（已实施）
   - 0、4、8、12、16、20 点更新
   - 每天最多 6 次 API 调用

2. **使用本地存储持久化缓存**
   - 即使刷新页面也能保留缓存
   - 减少重复的 API 调用

3. **批量获取主要货币对**
   - 一次 API 调用获取多个货币对
   - 减少总调用次数

### 方案三：使用备用 API 服务
- 集成多个汇率 API 提供商
- 主 API 限流时自动切换
- 提高服务可用性

## 当前状态

### 已优化
- ✅ 禁用预加载功能
- ✅ 24小时缓存机制
- ✅ 改进错误提示
- ✅ 只在固定时间点更新历史数据

### 待优化
- ⏳ 添加本地存储持久化缓存
- ⏳ 实现 API 调用计数和监控
- ⏳ 考虑升级 API 套餐

## 用户提示

当遇到 API 限流时，网站会显示：
> "API请求频率超限（每日200次已用完），请明天再试或升级API套餐。当前使用24小时内的缓存汇率。"

这意味着：
1. 如果之前成功获取过汇率，会使用 24 小时内的缓存数据
2. 如果没有任何缓存，会显示系统故障
3. 每天 UTC 0 点（北京时间 8 点）会重置配额

## 监控建议

建议添加以下监控：
1. **API 调用计数**：跟踪每日 API 调用次数
2. **限流预警**：接近限制时提前提醒
3. **缓存命中率**：监控缓存使用情况
4. **错误日志**：记录所有 API 错误

## 临时解决方案

如果急需使用，可以：
1. **等待重置**：每天 UTC 0 点（北京时间 8 点）自动重置
2. **使用缓存**：如果之前有成功获取的数据，24 小时内仍可使用
3. **升级套餐**：升级到付费套餐获得更多配额

